# å°†**å˜çš„éƒ¨åˆ†**ä¸**ä¸å˜çš„éƒ¨åˆ†**åˆ†ç¦»

## å“ªäº›æƒ…å†µç»„ä»¶ä¼šé‡æ–°æ¸²æŸ“ï¼Ÿ
1. ç»„ä»¶è‡ªå·±çš„stateå˜åŒ–ã€‚
2. çˆ¶ç»„ä»¶ä¼ é€’çš„propså˜åŒ–ã€‚
3. çˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

## å¦‚ä½•æŸ¥çœ‹ç»„ä»¶æ˜¯å¦è§¦å‘æ¸²æŸ“ï¼Ÿ
1. ä¸‹è½½è°·æ­Œæµè§ˆå™¨æ’ä»¶(React Developer Tools)ã€‚
2. React Developer Toolsè®¾ç½®ä¸­å‹¾é€‰é«˜äº®æç¤ºã€‚

<image src="./images/ç¬¬ä¸‰æ–¹é«˜äº®æç¤º.png" />

## ç¤ºä¾‹ï¼š
```ts
import { useState } from "react"

function App() {
  const [num, setUpadateNum] = useState(0)

  return (
    <div style={{ padding: 30 }}>
      <input value={num} onChange={e => setUpadateNum(e.target.value)} />
      <p>num is {num}</p>
      <ExpensiveCpn />
    </div>
  )
}

function ExpensiveCpn() {
  const now = performance.now() // Performance æ¥å£å¯ä»¥è·å–åˆ°å½“å‰é¡µé¢ä¸­ä¸æ€§èƒ½ç›¸å…³çš„ä¿¡æ¯
  while (performance.now() - now < 100) {}
  console.log('è€—æ—¶ç»„ä»¶ render')
  return <p>è€—æ—¶ç»„ä»¶</p>
}

export default App
```
### æ¯æ¬¡è¾“å…¥inputæ—¶éƒ½ä¼šè§¦å‘é¡µé¢æ›´æ–°ï¼Œä½¿ExpensiveCpnç»„ä»¶ä¸€ç›´æ›´æ–°æ‰“å°ä¿¡æ¯

<image src="./images/è€—æ—¶ç»„ä»¶1.png" />

### å°†è€—æ—¶çš„inputæ‹†åˆ†ï¼Œå¯å‡å°‘æ•´ä¸ªé¡µé¢çš„æ¸²æŸ“å¼€æ”¯ï¼š

```ts
import { useState } from "react"

function App() {
  // const [num, setUpadateNum] = useState(0)

  return (
    <div style={{ padding: 30 }}>
      {/* <input value={num} onChange={e => setUpadateNum(e.target.value)} />
      <p>num is {num}</p> */}
      <Input />
      <ExpensiveCpn />
    </div>
  )
}

// æ–°å¢ï¼šå°†Inputåˆ†ç¦»
function Input() {
  const [num, setUpadateNum] = useState(0)

  return (
    <>
      <input value={num} onChange={e => setUpadateNum(e.target.value)} />
      <p>num is {num}</p>
    </>
  )
}

function ExpensiveCpn() {
  const now = performance.now() // Performance æ¥å£å¯ä»¥è·å–åˆ°å½“å‰é¡µé¢ä¸­ä¸æ€§èƒ½ç›¸å…³çš„ä¿¡æ¯
  while (performance.now() - now < 100) {}
  console.log('è€—æ—¶ç»„ä»¶ render')
  return <p>è€—æ—¶ç»„ä»¶</p>
}

export default App
```

### åªæœ‰é¦–æ¬¡è¿›å…¥ä¼šè§¦å‘ExpensiveCpnç»„ä»¶æ¸²æŸ“ï¼Œinputè¾“å…¥åªä¼šæ›´æ–°Inputç»„ä»¶å†…çš„æ›´æ–°æ¸²æŸ“ã€‚

<image src="./images/è€—æ—¶ç»„ä»¶2.png" />

### PS: å¦‚æœ**ç»„ä»¶åˆ†ç¦»**åšçš„å¥½ï¼Œå®Œå…¨å¯ä»¥ä¸éœ€è¦é¢å¤–ä½¿ç”¨æ€§èƒ½ä¼˜åŒ–APIã€‚

# æ·»åŠ keyå‡å°‘ä¸å¿…è¦æ¸²æŸ“
### åœºæ™¯ï¼šä½¿ç”¨å…ƒç´ æ¢ä½ç­‰æƒ…å†µ
```ts
function App() {
  const [num, setNum] = useState(0)

  const a = (
    <>
      <div>div</div>
      <p>p</p>
    </>
  )

  const b = (
    <>
      <p>p</p>
      <div>div</div>
    </>
  )

  return (
    <div onClick={() => setNum(num + 1)}>
      { num % 2 === 0 ? a : b }
    </div>
  );
}
```
<image src="./images/æœªåŠ key.png" />

### divå’Œpéƒ½è§¦å‘äº†æ›´æ–°

### æ·»åŠ keyä¹‹åï¼š
```ts
  const a = (
    <>
      <div key='div'>div</div>
      <p key='p'>p</p>
    </>
  )

  const b = (
    <>
      <p key='p'>p</p>
      <div key='div'>div</div>
    </>
  )
```
<image src="./images/æ·»åŠ key.jpg" />

### åªæ›´æ–°äº†divï¼Œpæ ‡ç­¾æœªæ›´æ–°ã€‚
### **ç”±äºdiffç®—æ³•æ˜¯æ²¡æœ‰keyæƒ…å†µæ˜¯åˆ é™¤è¯¥DOMèŠ‚ç‚¹ä¹‹åé‡æ–°æ·»åŠ æ–°çš„DOMèŠ‚ç‚¹ï¼Œæ·»åŠ keyä½¿å¾—diffç®—æ³•çŸ¥é“ä¸Šæ¬¡æ›´æ–°Fiberç»“ç‚¹å­˜åœ¨DOMèŠ‚ç‚¹ä¸”èƒ½å¤ç”¨ã€‚**

# ä½¿ç”¨æ€§èƒ½ä¼˜åŒ–API

## å¦‚ä½•æ¯”è¾ƒpropsï¼Ÿ
### å…¨ç­‰æ¯”è¾ƒâ€”â€”â€”â€”é«˜æ•ˆï¼Œä½†ä¸å®¹æ˜“å‘½ä¸­
### æµ…æ¯”è¾ƒâ€”â€”â€”â€”ä¸é«˜æ•ˆï¼Œå®¹æ˜“å‘½ä¸­ï¼ˆmemoåŒ…è£¹ä½ï¼‰

## useMemoä½¿ç”¨åœºæ™¯ï¼š
### å¦‚æœä¸€äº›å€¼è®¡ç®—é‡å¾ˆå¤§ï¼Œå¯ä»¥ä½¿ç”¨useMemoç¼“å­˜è¯¥è®¡ç®—ï¼Œåªæœ‰ä¾èµ–å˜åŒ–æ—¶æ‰ä¼šé‡æ–°è®¡ç®—ï¼Œè€Œä¸æ˜¯æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½è¿›è¡Œè®¡ç®—ã€‚

## useCallbackä½¿ç”¨åœºæ™¯ï¼š
1. å¯¹äºéœ€è¦ä¼ é€’â€œ**å‡½æ•°**â€ç»™å­ç»„ä»¶çš„åœºåˆï¼Œä¸å®¤å‹useCallbackçš„è¯ï¼Œå­ç»„ä»¶æ¯æ¬¡éƒ½ä¼šé‡æ–°æ¸²æŸ“ã€‚
2. åœ¨è°ƒç”¨èŠ‚æµã€é˜²æŠ–å‡½æ•°æ—¶ã€‚

```ts
import { useState } from 'react'

interface IProps {
  children: React.ReactNode;
  onClick: () => void;
}
function Button(props: IProps) {
  const { children, onClick } = props

  return (
    <>
      <button onClick={onClick}>{children}</button>
      <p>{ Math.random() }</p>
    </>
  )
}

function App() {
  const [count, setCount] = useState(0)

  const onClick = () => {
     setCount(count + 1)
  }

  return (
    <div style={{ padding: 30 }}>
      <p>count: { count }</p>
      <Button onClick={onClick}>ç´¯åŠ </Button>
    </div>
  )
}

export default App
```

### æ¯æ¬¡ç´¯åŠ éƒ½ä¼šè§¦å‘Buttonç»„ä»¶ä¸­çš„Math.random()ï¼š

<image src="./images/ç´¯åŠ 1.png" />

## æ–¹æ³•ä¸€ï¼šä½¿ç”¨useMemoåŒ…è£¹Buttonç»„ä»¶
```ts
import { useMemo, useState } from 'react'

interface IProps {
  children: React.ReactNode;
  onClick: () => void;
}
function Button(props: IProps) {
  const { children, onClick } = props

  // æ–°å¢
  return useMemo(() => (
    <>
      <button onClick={onClick}>{children}</button>
      <p>{ Math.random() }</p>
    </>
  ), [])
}

function App() {
  const [count, setCount] = useState(0)

  const onClick = () => {
    // å‡½æ•°å½¢å¼æ‰èƒ½è·å–æœ€æ–°å€¼
    setCount((count) => count + 1)
  }

  return (
    <div style={{ padding: 30 }}>
      <p>count: { count }</p>
      <Button onClick={onClick}>ç´¯åŠ </Button>
    </div>
  )
}

export default App
```

## æ–¹æ³•äºŒï¼šmemo+useCallback
```ts
// Button.tsx
import { memo } from 'react'

interface IProps {
  children: React.ReactNode;
  onClick: () => void;
}

function Button(props: IProps) {
  const { children, onClick } = props

  // æ–°å¢
  return (
    <>
      <button onClick={onClick}>{children}</button>
      <p>{ Math.random() }</p>
    </>
  )
}

// æ–°å¢
export default memo(Button)
```

```ts
// App.tsx
import { useCallback, useState } from 'react'
import Button from './Button'

function App() {
  const [count, setCount] = useState(0)

  // æ–°å¢
  const onClick = useCallback(() => {
    // å‡½æ•°å½¢å¼æ‰èƒ½è·å–æœ€æ–°å€¼
    setCount((count) => count + 1)
  }, [])

  return (
    <div style={{ padding: 30 }}>
      <p>count: { count }</p>
      <Button onClick={onClick}>ç´¯åŠ </Button>
    </div>
  )
}

export default App
```

# ä½¿ç”¨`children`å±æ€§å¤§å¹…æå‡åº”ç”¨æ€§èƒ½
âŒ é”™è¯¯ç¤ºèŒƒï¼š æ¯å½“ Dashboard æ¸²æŸ“æ—¶ï¼ˆå³æ¯æ¬¡å½“å‰æ—¶é—´æ›´æ–°æ—¶ï¼‰ï¼ŒMyVerySlowComponent éƒ½ä¼šé‡æ–°æ¸²æŸ“ã€‚
```ts
function App() {
  // å…¶ä»–é€»è¾‘...
  return <Dashboard />;
}

function Dashboard() {
  const [currentTime, setCurrentTime] = useState(new Date());
  useEffect(() => {
    const intervalId = setInterval(() => {
      setCurrentTime(new Date());
    }, 1_000);
    return () => clearInterval(intervalId);
  }, []);

  return (
    <>
      <h1>{currentTime.toTimeString()}</h1>
      <MyVerySlowComponent />
    </>
  );
}
```

âœ… æ­£ç¡®ç¤ºèŒƒï¼š MyVerySlowComponent ä¸ä¼šä¸å¿…è¦åœ°é‡æ–°æ¸²æŸ“ã€‚
```ts
function App() {
  return (
    <Dashboard>
      <MyVerySlowComponent />
    </Dashboard>
  );
}

function Dashboard({ children }) {
  const [currentTime, setCurrentTime] = useState(new Date());
  useEffect(() => {
    const intervalId = setInterval(() => {
      setCurrentTime(new Date());
    }, 1_000);
    return () => clearInterval(intervalId);
  }, []);

  return (
    <>
      <h1>{currentTime.toTimeString()}</h1>
      {children}
    </>
  );
}
```

# ä½•æ—¶ä½¿ç”¨ Refs è€Œä¸æ˜¯ State
Refs éå¸¸é€‚åˆé‚£äº›*ä¸åº”è§¦å‘é‡æ–°æ¸²æŸ“*çš„å€¼ã€‚

ä¸å…¶é»˜è®¤ä½¿ç”¨ stateï¼Œä¸å¦‚å…ˆé—®é—®è‡ªå·±ï¼šâ€œè¿™ä¸ªå€¼æ”¹å˜æ—¶éœ€è¦è§¦å‘é‡æ–°æ¸²æŸ“å—ï¼Ÿâ€ å¦‚æœç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå°±ä½¿ç”¨ refã€‚

å®ƒä»¬éå¸¸é€‚åˆè·Ÿè¸ªå¯å˜å€¼ï¼Œå¦‚è®¡æ—¶å™¨ã€DOM å…ƒç´ æˆ–åœ¨æ¸²æŸ“ä¹‹é—´ä¿æŒä½†ä¸å½±å“ UI çš„å€¼ã€‚

âŒ é”™è¯¯ç¤ºèŒƒï¼šæˆ‘ä»¬åœ¨ state ä¸­å­˜å‚¨ intervalIdã€‚å½“ intervalId çŠ¶æ€æ”¹å˜æ—¶ç»„ä»¶ä¼šé‡æ–°æ¸²æŸ“ï¼Œå³ä½¿ UI ä¿æŒä¸å˜ã€‚
```ts
function Timer() {
  const [time, setTime] = useState(new Date());
  const [intervalId, setIntervalId]= useState();

  useEffect(() => {
    const id = setInterval(() => {
      setTime(new Date());
    }, 1_000);
    setIntervalId(id);
    return () => clearInterval(id);
  }, []);

  const stopTimer = () => {
    intervalId && clearInterval(intervalId);
  };

  return (
    <>
      <>å½“å‰æ—¶é—´ï¼š{time.toLocaleTimeString()} </>
      <button onClick={stopTimer}>åœæ­¢è®¡æ—¶å™¨</button>
    </>
  );
}
```

âœ… æ­£ç¡®ç¤ºèŒƒï¼šæˆ‘ä»¬å°† intervalId å­˜å‚¨ä¸º refã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¸ä¼šæœ‰é¢å¤–çš„çŠ¶æ€è§¦å‘é‡æ–°æ¸²æŸ“ã€‚
```ts
function Timer() {
  const [time, setTime] = useState(new Date());
  const intervalIdRef = useRef();
  const intervalId = intervalIdRef.current;

  useEffect(() => {
    const id = setInterval(() => {
      setTime(new Date());
    }, 1_000);
    intervalIdRef.current = id;
    return () => clearInterval(id);
  }, []);

  const stopTimer = () => {
    intervalId && clearInterval(intervalId);
  };

  return (
    <>
      <>å½“å‰æ—¶é—´ï¼š{time.toLocaleTimeString()} </>
      <button onClick={stopTimer}>åœæ­¢è®¡æ—¶å™¨</button>
    </>
  );
}
```

# ä¼˜å…ˆä½¿ç”¨å‘½åå¯¼å‡ºè€Œä¸æ˜¯é»˜è®¤å¯¼å‡º
å‘½åå¯¼å‡ºä½¿é‡æ„å’Œè°ƒè¯•æ›´å®¹æ˜“ã€‚

âŒ é”™è¯¯ç¤ºèŒƒï¼šé‡å‘½åéœ€è¦æ‰‹åŠ¨æ›´æ–°ã€‚
```ts
export default function Button() {}
// ä¹‹å...
import Button from './Button';
```

âœ… æ­£ç¡®ç¤ºèŒƒï¼šé‡å‘½åä¼šè‡ªåŠ¨å‘ç”Ÿã€‚
```ts
export function Button() {}
// ä¹‹å...
import { Button } from './Button';
```

# å°½å¯èƒ½é¿å…ä½¿ç”¨ useEffect

å¤„ç†è¿‡çš„æ¯ä¸€æ¬¡åº”ç”¨å´©æºƒèƒŒåéƒ½è—ç€ useEffect ğŸ˜…ã€‚

âŒ é”™è¯¯ç¤ºèŒƒï¼šåœ¨ useEffect ä¸­è°ƒç”¨ onToggledã€‚
```ts
function Toggle({ onToggled }) {
    const [on, setOn] = React.useState(false);
    const toggle = () => setOn(!on);
    
    useEffect(() => {
        onToggled(on);
    }, [on]);

    return (
        <button onClick={toggle}>
            {on ? 'on' : 'off'}
        </button>
    );
}
```

âœ… æ­£ç¡®ç¤ºèŒƒï¼šåœ¨ç›¸å…³æ—¶æœºè°ƒç”¨ onToggledã€‚
```ts
function Toggle({ onToggled }) {
    const [on, setOn] = React.useState(false);
    const handleToggle = () => {
        const next = !on;
        setOn(next);
        onToggled(next);
    };
    return (
        <button onClick={handleToggle}>
            {on ? 'on' : 'off'}
        </button>
    );
}
```

ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æ›´å¤šé¿å…ä½¿ç”¨ useEffect çš„æŠ€å·§ ğŸ‘‰ [ä½ å¯èƒ½ä¸éœ€è¦ Effect](https://react.dev/learn/you-might-not-need-an-effect)ã€‚
